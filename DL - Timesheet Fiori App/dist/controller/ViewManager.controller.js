sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/library","sap/ui/core/Fragment","sap/ui/model/Filter","sap/ui/core/format/DateFormat","sap/ui/core/ValueState","sap/m/MessageToast","sap/m/MessageBox","sap/ui/core/routing/History"],function(e,t,a,r,s,i,o,n,l){"use strict";return e.extend("zfioritimesheet3.zfioritimesheet3n.controller.ViewManager",{onInit:function(){sap.ui.core.BusyIndicator.show();var e=this,t=e.getView(),a=t.byId("planCaleTeam"),s=new Date,i="mainService",o="jsonService",n="jsonTeamEventsService",l="jsonManagerService",d=this.getOwnerComponent().getModel(i),g=this.getOwnerComponent().getModel(o),u=this.getOwnerComponent().getModel(l),p=this.getOwnerComponent().getModel(n),c;var h=u.getProperty("/flagExecuted");if(h){sap.ui.core.BusyIndicator.hide();return false}u.setProperty("/flagExecuted",true);u.refresh();if(a){if(this.getOwnerComponent().byId("container-zfiori_timesheet_3n---ViewManager--planCaleTeam-Header-ViewSwitch"))this.getOwnerComponent().byId("container-zfiori_timesheet_3n---ViewManager--planCaleTeam-Header-ViewSwitch").setWidth("350px");if(this.getOwnerComponent().byId("application-ZPS_CAT-display-component---ViewManager--planCaleTeam-Header-ViewSwitch"))this.getOwnerComponent().byId("application-ZPS_CAT-display-component---ViewManager--planCaleTeam-Header-ViewSwitch").setWidth("350px");a.setStartDate(new Date(s.getFullYear(),s.getMonth(),s.getDate(),1));a.setMinDate(new Date(s.getFullYear(),s.getMonth(),1));a.setMaxDate(new Date(s.getFullYear(),s.getMonth()+1,0,23,59,59,999))}var m="/people/0/key",y=g.getProperty(m),b=new r({filters:[new r({path:"InputUname",operator:sap.ui.model.FilterOperator.EQ,value1:y})]}),f="";f=b;d.read("/UserTeamSet",{filters:[f],success:function(t){var a="/people",r=u.getProperty(a),s;for(s=0;s<t.results.length;s++){var i={key:t.results[s].Uname,key2:t.results[s].Pernr,title:t.results[s].Uname,text:t.results[s].Unamex,icon:"sap-icon://employee",manager:false,appointments:[]};r.push(i)}if(!u.setProperty(a,r)){sap.ui.core.BusyIndicator.hide();e.showTeamExtractionError();return false}var o="/appointments",n=p.getProperty(o),l,d;for(s=0;s<t.results.length;s++){var g="/people/"+r.findIndex(e=>e.key==t.results[s].Uname)+"/appointments",h=u.getProperty(g);for(d=0;d<n.length;d++){if(n[d].user!=t.results[s].Uname)continue;l=n[d];h.push(l)}if(!u.setProperty(g,h))c="X"}if(c){sap.ui.core.BusyIndicator.hide();e.showTeamExtractionError()}else{u.refresh();sap.ui.core.BusyIndicator.hide()}},error:function(t){sap.ui.core.BusyIndicator.hide();e.showTeamExtractionError(t)}})},onNavBack:function(){if(l.getInstance().getPreviousHash()){window.history.back()}else{var e=sap.ui.core.UIComponent.getRouterFor(this);if(e)e.navTo("RouteViewMain",null,true)}},msToTime:function(e){var t=(e,t=2)=>("00"+e).slice(-t);return t(e/36e5|0)+":"+t(e%36e5/6e4|0)+":"+t(e%6e4/1e3|0)+"."+t(e%1e3,3)},hoursToMs:function(e){return e*36e5},dateToYyyyMmDd:function(e){return new Date(e.getTime()-e.getTimezoneOffset()*6e4).toISOString().split("T")[0]},dateToString:function(e){if(e)return e.getDate().toString().padStart(2,"0")+"/"+(e.getMonth()+1).toString().padStart(2,"0")+"/"+e.getFullYear().toString().substring(2,4).padStart(2,"0")+", "+e.getHours().toString().padStart(2,"0")+":"+e.getMinutes().toString().padStart(2,"0")},formatDateToMediumString:function(e){return s.getDateInstance({style:"medium"}).format(e)},formatDateString:function(e){return new Date(e)},timeStringToDecimal:function(e){return e.split(":").map(function(e){return parseInt(e,10)}).reduce(function(e,t,a){return e+t/Math.pow(60,a)})},roundTo2DecimalsString:function(e){var t=e>=0?1:-1;return(Math.round(e*Math.pow(10,2)+t*.001)/Math.pow(10,2)).toFixed(2).toString()},showTeamExtractionError:function(e){var t=this.getOwnerComponent().getModel("i18n").getResourceBundle(),a="sapUiResponsivePadding--header sapUiResponsivePadding--content sapUiResponsivePadding--footer",r;if(e){try{r="<p><strong>"+t.getText("messageBoxErrorDetailsText")+"</strong><br/>"+JSON.parse(e.responseText).error.innererror.errordetails[0].message+"</p>"}catch(a){r="<p><strong>"+t.getText("messageBoxErrorDetailsText")+"</strong><br/>"+e.responseText+"</p>"}n.error(t.getText("messageBoxTeamExtractionError"),{title:t.getText("messageBoxTeamExtractionErrorTitle"),details:r,styleClass:!jQuery.support.touch?a:""})}else{n.error(t.getText("messageBoxTeamExtractionError"),{title:t.getText("messageBoxTeamExtractionErrorTitle"),styleClass:!jQuery.support.touch?a:""})}},showWbsPrefError:function(e,t){var a="sapUiResponsivePadding--header sapUiResponsivePadding--content sapUiResponsivePadding--footer",r=this.getOwnerComponent().getModel("i18n").getResourceBundle(),s;try{s="<p><strong>"+r.getText("messageBoxErrorDetailsText")+"</strong><br/>"+JSON.parse(e.responseText).error.innererror.errordetails[0].message+"</p>"}catch(t){s="<p><strong>"+r.getText("messageBoxErrorDetailsText")+"</strong><br/>"+e.responseText+"</p>"}if(t=="C"){n.error(r.getText("messageBoxWbsPrefErrorCreate"),{title:r.getText("messageBoxWbsPrefErrorTitle"),details:s,styleClass:!jQuery.support.touch?a:""})}else if(t=="D"){n.error(r.getText("messageBoxWbsPrefErrorDelete"),{title:r.getText("messageBoxWbsPrefErrorTitle"),details:s,styleClass:!jQuery.support.touch?a:""})}},showWbsPrefErrorMoreItems:function(){var e="sapUiResponsivePadding--header sapUiResponsivePadding--content sapUiResponsivePadding--footer",t=this.getOwnerComponent().getModel("i18n").getResourceBundle();n.error(t.getText("messageBoxWbsPrefErrorMoreItems"),{title:t.getText("messageBoxWbsPrefErrorTitle"),styleClass:!jQuery.support.touch?e:""})},showWbsPrefErrorNotPreferred:function(){var e="sapUiResponsivePadding--header sapUiResponsivePadding--content sapUiResponsivePadding--footer",t=this.getOwnerComponent().getModel("i18n").getResourceBundle();n.error(t.getText("messageBoxWbsPrefErrorNotPreferred"),{title:t.getText("msgError"),styleClass:!jQuery.support.touch?e:""})},showErrorNotEditable:function(){var e="sapUiResponsivePadding--header sapUiResponsivePadding--content sapUiResponsivePadding--footer",t=this.getOwnerComponent().getModel("i18n").getResourceBundle();n.error(t.getText("msgErrorNotEditable"),{title:t.getText("msgError"),styleClass:!jQuery.support.touch?e:""})},showDeleteError:function(e){var t=this.getOwnerComponent().getModel("i18n").getResourceBundle(),a="sapUiResponsivePadding--header sapUiResponsivePadding--content sapUiResponsivePadding--footer",r;try{r="<p><strong>"+t.getText("messageBoxErrorDetailsText")+"</strong><br/>"+JSON.parse(e.responseText).error.innererror.errordetails[0].message+"</p>"}catch(a){r="<p><strong>"+t.getText("messageBoxErrorDetailsText")+"</strong><br/>"+e.responseText+"</p>"}n.error(t.getText("msgErrorDeleteText"),{title:t.getText("msgError"),details:r,styleClass:!jQuery.support.touch?a:""})},showUpdateError:function(e){var t=this.getOwnerComponent().getModel("i18n").getResourceBundle(),a="sapUiResponsivePadding--header sapUiResponsivePadding--content sapUiResponsivePadding--footer",r;try{r="<p><strong>"+t.getText("messageBoxErrorDetailsText")+"</strong><br/>"+JSON.parse(e.responseText).error.innererror.errordetails[0].message+"</p>"}catch(a){r="<p><strong>"+t.getText("messageBoxErrorDetailsText")+"</strong><br/>"+e.responseText+"</p>"}n.error(t.getText("msgErrorUpdateText"),{title:t.getText("msgError"),details:r,styleClass:!jQuery.support.touch?a:""})},showCreateError:function(e){var t=this.getOwnerComponent().getModel("i18n").getResourceBundle(),a="sapUiResponsivePadding--header sapUiResponsivePadding--content sapUiResponsivePadding--footer",r;try{r="<p><strong>"+t.getText("messageBoxErrorDetailsText")+"</strong><br/>"+JSON.parse(e.responseText).error.innererror.errordetails[0].message+"</p>"}catch(a){r="<p><strong>"+t.getText("messageBoxErrorDetailsText")+"</strong><br/>"+e.responseText+"</p>"}n.error(t.getText("msgErrorCreateText"),{title:t.getText("msgError"),details:r,styleClass:!jQuery.support.touch?a:""})},showUnknownError:function(e){var t=this.getOwnerComponent().getModel("i18n").getResourceBundle(),a="sapUiResponsivePadding--header sapUiResponsivePadding--content sapUiResponsivePadding--footer",r;try{r="<p><strong>"+t.getText("messageBoxErrorDetailsText")+"</strong><br/>"+JSON.parse(e.responseText).error.innererror.errordetails[0].message+"</p>"}catch(a){r="<p><strong>"+t.getText("messageBoxErrorDetailsText")+"</strong><br/>"+e.responseText+"</p>"}n.error(t.getText("msgGeneralErrorText"),{title:t.getText("msgError"),details:r,styleClass:!jQuery.support.touch?a:""})},onPressBtnWbs:function(e){var t=e.getSource(),r=this.getView();if(!this._pDialog){this._pDialog=a.load({id:r.getId(),name:"zfioritimesheet3.zfioritimesheet3n.view.FragmentWbs",controller:this}).then(function(e){r.addDependent(e);return e})}this._pDialog.then(function(e){this._configDialogWbs(t,e);if(e)e.open()}.bind(this))},_configDialogWbs:function(e,t){var a=e.data("responsivePadding"),s="sapUiResponsivePadding--header sapUiResponsivePadding--subHeader sapUiResponsivePadding--content sapUiResponsivePadding--footer",i=this.getOwnerComponent().getModel("i18n").getResourceBundle(),o=t._getCancelButton();if(a){t.addStyleClass(s)}else{t.removeStyleClass(s)}o.setText(i.getText("textBtnCloseWbs"));o.setTooltip(i.getText("tooltipBtnCloseWbs"));var n=this.getView().byId("tableSelectDialogWbs"),l,d=new r({filters:[new r({path:"InputExtractOnlyPrefWbs",operator:sap.ui.model.FilterOperator.EQ,value1:"X"})]}),g=this.byId("btnShowAllWbs");g.setPressed(false);l=n.getBinding("items");l.filter([d])},handleSearchTableSelectDialogWbs:function(e){sap.ui.core.BusyIndicator.show();var t=e.getParameter("value"),a=new r({filters:[new r({path:"InputPosid",operator:sap.ui.model.FilterOperator.EQ,value1:t}),new r({path:"InputPost1",operator:sap.ui.model.FilterOperator.EQ,value1:t}),new r({path:"InputSearch",operator:sap.ui.model.FilterOperator.EQ,value1:"X"})],and:true}),s=e.getSource().getBinding("items");s.filter([a]);sap.ui.core.BusyIndicator.hide()},handleCloseTableSelectDialogWbs:function(e){var t=e.getSource().getBinding("items");t.filter([])},handleSelectTableSelectDialogWbs:function(e){sap.ui.core.BusyIndicator.show();var t=this.getOwnerComponent().getModel("mainService"),a=e.getSource().getBinding("items"),r=e.getParameters("selectedItems").selectedItems,s,i;a.filter([]);if(r.length>1){sap.ui.core.BusyIndicator.hide();that.showWbsPrefErrorMoreItems();return false}s=r[0];i=t.getProperty(s.getBindingContextPath());if(!i.Pref){sap.ui.core.BusyIndicator.hide();this.showWbsPrefErrorNotPreferred();return false}this._arrangeDialogFragmentCreateWithWbs(i)},_arrangeDialogFragmentCreateWithWbs:function(e){var t=this.getView();if(!this._pNewAppointmentDialog){this._pNewAppointmentDialog=a.load({id:t.getId(),name:"zfioritimesheet3.zfioritimesheet3n.view.FragmentCreazioneManager",controller:this}).then(function(e){t.addDependent(e);return e})}this._pNewAppointmentDialog.then(function(t){this._arrangeDialogCreateWithWbs(t,e)}.bind(this))},_arrangeDialogCreateWithWbs:function(e,t){var a="",r=this.getOwnerComponent().getModel("i18n").getResourceBundle(),s=this.byId("selectDipName"),o=this.byId("actType"),n=this.byId("wbsType"),l=this.byId("createStartDate"),d=this.byId("createEndDate"),g=this.byId("createGiornoDate"),u=this.byId("oreLavorate"),p=this.byId("appTitle"),c=this.byId("moreInfo");s.setValueState(i.None);o.setValueState(i.None);n.setValueState(i.None);l.setValueState(i.None);d.setValueState(i.None);g.setValueState(i.None);u.setValueState(i.None);p.setValueState(i.None);c.setValueState(i.None);this._setCreateAppointmentDialogContentCreateWithWbs(t);a=r.getText("titleCreateAppointmentDialog");e.setTitle(a);this.onChangeInputValuesCreate();sap.ui.core.BusyIndicator.hide();e.open()},_setCreateAppointmentDialogContentCreateWithWbs:function(e){var t=this.getOwnerComponent().getModel("jsonManagerService"),a=this.getView().byId("planCaleTeam"),r,i=this.byId("createStartDate"),o=this.byId("createEndDate"),n=this.byId("createGiornoDate"),l=this.byId("appTitle"),d=this.byId("moreInfo"),g=this.byId("selectDipName"),u=this.byId("actType"),p=this.byId("wbsType"),c=this.byId("wbsTypeLabelCreate"),h="LAV005",m="Lavoro",y,b,f,I,D,S,T=this.getOwnerComponent().getModel("paramModel"),v=t.getProperty("/people/0");p.setEditable(true);p.setVisible(true);c.setVisible(true);if(a._dateNav._start){r=a._dateNav._start}else{r=new Date}if(T){if(T.oData){f=T.oData.startDate;I=T.oData.endDate;D=f.getHours().toString().padStart(2,"0")+":"+f.getMinutes().toString().padStart(2,"0");S=I.getHours().toString().padStart(2,"0")+":"+I.getMinutes().toString().padStart(2,"0");y=Math.abs(this.timeStringToDecimal(S)-this.timeStringToDecimal(D));if(y>0){b=this.roundTo2DecimalsString(y)}else{b=""}T.setData(null);T.updateBindings(true)}else{f=r;I=r;b=""}}else{f=r;I=r;b=""}var V=new Date(f),w=new Date(I);var t=this.getOwnerComponent().getModel("jsonManagerService");g.setValue(v.text);g.setSelectedItem(v.key);g.setSelectedKey(v.key);var x={userPernr:v.key2,user:v.key};var E=new sap.ui.model.json.JSONModel;E.setData(x);this.getOwnerComponent().setModel(E,"keyModel");var M=s.getDateTimeInstance({style:"medium"}).format(V);var P=s.getDateTimeInstance({style:"medium"}).format(w);var C=s.getDateInstance({style:"medium"}).format(V);i.setValue(M);o.setValue(P);n.setValue(C);l.setValue("");d.setValue("");u.setValue(m);u.setSelectedItem(h);u.setSelectedKey(h);p.setValue(e.Post1);p.setSelectedItem(e.Rproj);p.setSelectedKey(e.Rproj);p.setEditable(true);this.getView().byId("lCreateStartDate").setVisible(false);i.setVisible(false);this.getView().byId("lCreateEndDate").setVisible(false);o.setVisible(false);this.getView().byId("lGiornoDate").setVisible(true);n.setVisible(true);this.getView().byId("lOreLavorate").setVisible(true);this.getView().byId("oreLavorate").setVisible(true);this.getView().byId("oreLavorate").setValue(b)},onPressBtnShowAllWbs:function(e){var t=this.getView().byId("tableSelectDialogWbs"),a,s,i;t.setBusy(true);a=t.getBinding("items");if(e.getSource().getPressed()){i=""}else{i="X"}s=new r({filters:[new r({path:"InputExtractOnlyPrefWbs",operator:sap.ui.model.FilterOperator.EQ,value1:i})]});a.filter([s]);t.setBusy(false)},onPressBtnAddRemovePrefWbs:function(e){sap.ui.core.BusyIndicator.show();var t=this,a="mainService",r=t.getView().getModel(a),s=this.getOwnerComponent().getModel("i18n").getResourceBundle(),i=e.getSource().oParent.oBindingContexts.mainService.sPath,n=r.getProperty(i),l,d;if(n.Pref){d=""}else{d="X"}l={InputUname:"",InputPernr:"",InputRproj:"",Uname:n.Uname,Pernr:n.Pernr,Rproj:n.Rproj,Posid:n.Posid,Post1:n.Post1,Pbukr:n.Pbukr,Werks:n.Werks,Usr00:n.Usr00,Kostl:n.Kostl,Pref:d};if(d){r.create("/WbsPrefSet",l,{success:function(){r.refresh();sap.ui.core.BusyIndicator.hide();o.show(s.getText("messageToastWbsPrefSuccess"))},error:function(e){sap.ui.core.BusyIndicator.hide();t.showWbsPrefError(e,"C")}})}else{r.remove("/WbsPrefSet(Uname='"+n.Uname+"',Pernr='"+n.Pernr+"',Rproj='"+n.Rproj+"')",{success:function(){r.refresh();sap.ui.core.BusyIndicator.hide();o.show(s.getText("messageToastWbsPrefSuccess"))},error:function(e){sap.ui.core.BusyIndicator.hide();t.showWbsPrefError(e,"D")}})}},onPressBtnTeamDays:function(e){var t=e.getSource(),r=this.getView();if(!this._pDialog2){this._pDialog2=a.load({id:r.getId(),name:"zfioritimesheet3.zfioritimesheet3n.view.FragmentDaysManager",controller:this}).then(function(e){r.addDependent(e);return e})}this._pDialog2.then(function(e){this._configDialogDaysManager(t,e);if(e)e.open()}.bind(this))},_configDialogDaysManager:function(e,t){if(!e)e=this.byId("btnDaysManager");if(!t)t=this.byId("dialogDaysManager");var a=e.data("responsivePadding"),o="sapUiResponsivePadding--header sapUiResponsivePadding--subHeader sapUiResponsivePadding--content sapUiResponsivePadding--footer";if(a){t.addStyleClass(o)}else{t.removeStyleClass(o)}var n=s.getDateInstance({pattern:"yyyy-MM-dd",UTC:false}),l=this.getOwnerComponent().getModel("jsonManagerService"),d=l.getProperty("/people/0"),g=this.getView().byId("listDialogDaysManager"),u=this.byId("selectUserDialogDaysManager"),p=this.byId("dateRangeWorkdateDialogDaysManager"),c=this.byId("switchShowOnlyDaysInErrorDialogDaysManager"),h=new Date,m=n.format(new Date(h.getFullYear(),h.getMonth()-1,h.getDate())),y=n.format(new Date(h.getFullYear(),h.getMonth(),h.getDate())),b=g.getBinding("items"),f=new r({filters:[new r({path:"InputUname",operator:sap.ui.model.FilterOperator.EQ,value1:d.key}),new r({path:"InputPernr",operator:sap.ui.model.FilterOperator.EQ,value1:d.key2}),new r({path:"InputWorkdateFrom",operator:sap.ui.model.FilterOperator.EQ,value1:m}),new r({path:"InputWorkdateTo",operator:sap.ui.model.FilterOperator.EQ,value1:y}),new r({path:"InputExtractOnlyDaysError",operator:sap.ui.model.FilterOperator.EQ,value1:""})],and:true});u.setValueState(i.None);p.setValueState(i.None);u.setValue(d.text);u.setSelectedItem(d.key);u.setSelectedKey(d.key);p.setValue(s.getDateInstance({style:"medium"}).format(new Date(h.getFullYear(),h.getMonth()-1,h.getDate()))+"-"+s.getDateInstance({style:"medium"}).format(h));c.setState(false);b.filter([f])},onUpdateFinishedListDialogDaysManager:function(e){this._updateListItemCountDialogDaysManager(e.getParameter("total"))},_updateListItemCountDialogDaysManager:function(e){var t=this.getOwnerComponent().getModel("i18n").getResourceBundle();if(this.byId("listDialogDaysManager").getBinding("items").isLengthFinal())this.byId("labelInfoToolbarDialogDaysManager").setText(t.getText("textDisplaydEntriesDialogDays")+e)},onPressBtnCloseDialogDaysManager:function(){var e=this.byId("listDialogDaysManager").getBinding("items");e.filter([]);this.byId("dialogDaysManager").close()},onPressBtnApplySelectedFiltersDialogDaysManager:function(){var e=this.getView().byId("listDialogDaysManager");e.setBusy(true);var t=s.getDateInstance({pattern:"yyyy-MM-dd",UTC:false}),a=this.getOwnerComponent().getModel("jsonManagerService"),i=this.byId("selectUserDialogDaysManager"),o=this.byId("dateRangeWorkdateDialogDaysManager"),n=this.byId("switchShowOnlyDaysInErrorDialogDaysManager"),l=a.getProperty("/people"),d=a.getProperty("/people/"+l.findIndex(e=>e.key==i.getSelectedKey())),g=o.getDateValue(),u=o.getSecondDateValue(),p=t.format(g),c=t.format(u),h=n.getState()?"X":"",m=e.getBinding("items"),y=new r({filters:[new r({path:"InputUname",operator:sap.ui.model.FilterOperator.EQ,value1:d.key}),new r({path:"InputPernr",operator:sap.ui.model.FilterOperator.EQ,value1:d.key2}),new r({path:"InputWorkdateFrom",operator:sap.ui.model.FilterOperator.EQ,value1:p}),new r({path:"InputWorkdateTo",operator:sap.ui.model.FilterOperator.EQ,value1:c}),new r({path:"InputExtractOnlyDaysError",operator:sap.ui.model.FilterOperator.EQ,value1:h})],and:true});m.filter([y]);e.setBusy(false)},onChangeSelectUserDialogDaysManager:function(){this._validateFilterValuesDialogDaysManager()},onChangeDateRangeWorkdateDialogDaysManager:function(){this._validateFilterValuesDialogDaysManager()},onChangeSwitchShowOnlyDaysInErrorDialogDaysManager:function(){this._validateFilterValuesDialogDaysManager()},_validateFilterValuesDialogDaysManager:function(){var e=this.getOwnerComponent().getModel("i18n").getResourceBundle(),t=this.byId("selectUserDialogDaysManager"),a=this.byId("dateRangeWorkdateDialogDaysManager");if(!t.getSelectedKey()){t.setValueState(i.Error);t.setValueStateText(e.getText("validationErrorTextEmtpyUser"))}else{t.setValueState(i.None)}if(!a.getValue()){a.setValueState(i.Error);a.setValueStateText(e.getText("validationErrorTextEmtpyDateRangeDialogDays"))}else if(!a._bValid){a.setValueState(i.Error);a.setValueStateText(e.getText("validationErrorTextInvalidDateRangeDialogDays"))}else{a.setValueState(i.None)}this._updateEnabledStateBtnApplySelectedFiltersDialogDaysManager()},_updateEnabledStateBtnApplySelectedFiltersDialogDaysManager:function(){var e=this.byId("selectUserDialogDaysManager"),t=this.byId("dateRangeWorkdateDialogDaysManager"),a=this.byId("btnApplySelectedFiltersDialogDaysManager");bEnabled=t.getValueState()!==i.Error&&e.getValueState()!==i.Error;a.setEnabled(bEnabled)},handlePlanCaleTeamAppoSele:function(e){sap.ui.core.BusyIndicator.show();var t=e.getParameter("appointment");if(t){var a=this.getOwnerComponent().getModel("jsonManagerService");var r=t.mBindingInfos.key.binding.oContext.sPath;var s=a.getProperty(r);var i=new sap.ui.model.json.JSONModel;i.setData(s);this.getOwnerComponent().setModel(i,"keyModel");this._handleAppointmentSelection(t)}},_handleAppointmentSelection:function(e){var t=this.getView();if(!e){sap.ui.core.BusyIndicator.hide();return}if(!e.getSelected()&&this._pDetailsPopover){this._pDetailsPopover.then(function(e){e.close()});sap.ui.core.BusyIndicator.hide();return}if(!this._pDetailsPopover){this._pDetailsPopover=a.load({id:t.getId(),name:"zfioritimesheet3.zfioritimesheet3n.view.FragmentDetails",controller:this}).then(function(e){t.addDependent(e);return e})}this._pDetailsPopover.then(function(t){this._setDetailsDialogContent(e,t)}.bind(this));sap.ui.core.BusyIndicator.hide()},_setDetailsDialogContent:function(e,t){var a=this,r=this.getOwnerComponent().getModel("i18n").getResourceBundle(),i=this.byId("moreInfoText"),o=this.byId("shortTextText"),n=this.byId("longTextText"),l=this.byId("wbsText"),d=this.byId("labelWbsDetails"),g=this.byId("labelStartDate"),u=this.byId("startDateText"),p=this.byId("endDateText"),c=this.byId("lEndDateText"),h=this.byId("endDateText"),m=this.byId("lOreLavoro"),y=this.byId("oreLavoro"),b=this.getOwnerComponent().getModel("jsonManagerService"),f=this.getOwnerComponent().getModel("mainService"),I=e.mBindingInfos.key.binding.oContext.sPath,D=b.getProperty(I),S="UserEventSet(Uname='"+D.user+"',Pernr='"+D.userPernr+"',Counter='"+D.key+"')",T=f.oData[S],v,V;if(e.mBindingInfos===undefined)e=T.getParameter("appointment");if(T.Status!=="10"){sap.ui.core.BusyIndicator.hide();a.showErrorNotEditable();return false}if(T.Tasklevel=="ASS001"){d.setVisible(false);l.setVisible(false);h.setVisible(true);c.setVisible(true);m.setVisible(false);y.setVisible(false);g.setText(r.getText("textFromLabel2"));var w=new Date(D.startDate);if(w){v=s.getDateTimeInstance({style:"medium"}).format(w);u.setText(v)}var x=new Date(D.endDate);if(x){V=s.getDateTimeInstance({style:"medium"}).format(x);p.setText(V)}}else{d.setVisible(true);l.setVisible(true);l.setText(D.wbsDescription);h.setVisible(false);c.setVisible(false);m.setVisible(true);y.setVisible(true);g.setText(r.getText("textDayLabel2"));var w=T.Workdate;var E=parseInt(this.msToTime(T.Beguz.ms).substring(0,2));var M=parseInt(this.msToTime(T.Beguz.ms).substring(3,5));w.setHours(E);w.setMinutes(M);v=s.getDateInstance({style:"medium"}).format(w);u.setText(v);y.setText(T.Catshours)}i.setText(D.text);o.setText(D.description);n.setText(D.longDescription);l.setText(D.wbsDescription);t.openBy(e)},handleDeleteAppointment:function(e){var t=this;var a=this.byId("detailsPopover");var r=this.getView().getModel("i18n").getResourceBundle();var s=r.getText("msgDelete");sap.m.MessageBox.confirm(s,{title:r.getText("msgDeleteTitle"),initialFocus:n.Action.CANCEL,onClose:function(e){if(e===sap.m.MessageBox.Action.OK){sap.ui.core.BusyIndicator.show();t._removeAppointment();a.close()}else{}},styleClass:!jQuery.support.touch?"sapUiSizeCompact":""})},_removeAppointment:function(){sap.ui.core.BusyIndicator.show();var e=this.getOwnerComponent().getModel("mainService"),t=this.getOwnerComponent().getModel("jsonManagerService"),a=this.getOwnerComponent().getModel("keyModel"),r=this.getView().getModel("i18n").getResourceBundle(),s=this,i=0,n=0,l,d;var g=a.getData().user,u=a.getData().key,p=t.getProperty("/people"),c=p.findIndex(e=>e.key==g),h=t.getProperty("/people/"+c);e.remove("/UserEventSet(Uname='"+h.key+"',Pernr='"+h.key2+"',Counter='"+u+"')",{success:function(){t.getProperty("/people/").forEach(function(e){if(e.key===h.key){l="/people/"+i.toString();l+="/appointments";d=t.getProperty(l);d.forEach(function(e){if(e.key===u){d.splice(n,1)}n=n+1})}i=i+1});sap.ui.core.BusyIndicator.hide();o.show(r.getText("msgOkDeleted"));s._ricaricaUserEvent()},error:function(e){sap.ui.core.BusyIndicator.hide();s.showDeleteError(e)}})},handleEditButton:function(e){var t=this.byId("detailsPopover");t.close();this._arrangeDialogFragmentModifica()},_arrangeDialogFragmentModifica:function(){sap.ui.core.BusyIndicator.show();var e=this.getView();if(!this._pModAppointmentDialog){this._pModAppointmentDialog=a.load({id:e.getId(),name:"zfioritimesheet3.zfioritimesheet3n.view.FragmentModificaManager",controller:this}).then(function(t){e.addDependent(t);return t})}this._pModAppointmentDialog.then(function(e){this._arrangeDialogModifica(e)}.bind(this))},_arrangeDialogModifica:function(e){var t=this.getOwnerComponent().getModel("i18n").getResourceBundle(),a="";this._setAppointmentDialogModifica();a=t.getText("titleEditAppointmentDialog");e.setTitle(a);this.onChangeInputValuesModifica();sap.ui.core.BusyIndicator.hide();e.open()},_setAppointmentDialogModifica:function(){var e=this.getOwnerComponent().getModel("jsonManagerService"),t=this.byId("selectModName"),a=this.byId("modActType"),r=this.byId("modWbsType"),o=this.byId("lModStartDate"),n=this.byId("modStartDate"),l=this.byId("lModEndDate"),d=this.byId("modEndDate"),g=this.byId("lModGiornoDate"),u=this.byId("modGiornoDate"),p=this.byId("lModOreLavorate"),c=this.byId("modOreLavorate"),h=this.byId("modAppTitle"),m=this.byId("modMoreInfo"),y,b,f,I,D,S,T=this.byId("modActType"),v=this.byId("modWbsType"),V=this.byId("modStartDate"),w=this.byId("modEndDate"),x=this.byId("modGiornoDate"),E=this.byId("modOreLavorate"),M=this.byId("modAppTitle"),P=this.byId("modMoreInfo");T.setValueState(i.None);v.setValueState(i.None);V.setValueState(i.None);w.setValueState(i.None);x.setValueState(i.None);E.setValueState(i.None);M.setValueState(i.None);P.setValueState(i.None);var C=this.getOwnerComponent().getModel("mainService");var k=this.getOwnerComponent().getModel("keyModel");var B=k.getData().user,O=k.getData().key;var U=e.getProperty("/people"),R=e.getProperty("/people/"+U.findIndex(e=>e.key==B));t.setValue(R.text);t.setSelectedItem(R.key);t.setSelectedKey(R.key);h.setValue(this.byId("shortTextText").getText());m.setValue(this.byId("longTextText").getText());var N="UserEventSet(Uname='"+R.key+"',Pernr='"+R.key2+"',Counter='"+O+"')";var W=C.oData[N];a.setValue(W.Tasklevelx);a.setSelectedItem(W.Tasklevel);a.setSelectedKey(W.Tasklevel);if(W.Tasklevel=="ASS001"){r.setEditable(false);r.setValue("");r.setSelectedItem("");r.setSelectedKey("");r.setVisible(false);this.byId("wbsTypeLabelModifica").setVisible(false);n.setVisible(true);o.setVisible(true);d.setVisible(true);l.setVisible(true);g.setVisible(false);u.setVisible(false);p.setVisible(false);c.setVisible(false);D=new Date(W.Workdate.getFullYear(),W.Workdate.getMonth(),W.Workdate.getDate());S=s.getDateTimeInstance({style:"short"}).format(D).substring(0,8);y=new Date(D);y.setHours(this.msToTime(W.Beguz.ms).split(":")[0]);y.setMinutes(this.msToTime(W.Beguz.ms).split(":")[1]);y.setSeconds(this.msToTime(W.Beguz.ms).split(":")[2].substring(0,2));f=this.dateToString(y);b=new Date(D);b.setHours(this.msToTime(W.Enduz.ms).split(":")[0]);b.setMinutes(this.msToTime(W.Enduz.ms).split(":")[1]);b.setSeconds(this.msToTime(W.Enduz.ms).split(":")[2].substring(0,2));I=this.dateToString(b);u.setValue(S);n.setValue(f);d.setValue(I);c.setValue(W.Catshours)}else{r.setEditable(true);r.setValue(W.Post1);r.setSelectedItem(W.Rproj);r.setSelectedKey(W.Rproj);r.setVisible(true);this.byId("wbsTypeLabelModifica").setVisible(true);n.setVisible(false);o.setVisible(false);d.setVisible(false);l.setVisible(false);g.setVisible(true);u.setVisible(true);p.setVisible(true);c.setVisible(true);D=new Date(W.Workdate.getFullYear(),W.Workdate.getMonth(),W.Workdate.getDate());S=s.getDateTimeInstance({style:"short"}).format(D).substring(0,8);y=new Date;y.setHours(0);y.setMinutes(0);y.setSeconds(0);f=this.dateToString(y);b=new Date;b.setHours(0);b.setMinutes(0);b.setSeconds(0);I=this.dateToString(b);u.setValue(S);n.setValue(f);d.setValue(I);c.setValue(W.Catshours)}},handleChangeSelectActivityModifica:function(){var e=this.getOwnerComponent().getModel("jsonManagerService");var t=this.getOwnerComponent().getModel("mainService");var a=this.getOwnerComponent().getModel("keyModel");var r=a.getData().user;var i=a.getData().key;var o=e.getProperty("/people"),n=e.getProperty("/people/"+o.findIndex(e=>e.key==r));var l="UserEventSet(Uname='"+n.key+"',Pernr='"+n.key2+"',Counter='"+i+"')";var d=t.oData[l];var g=this.getView().byId("modActType");var u=this.byId("modWbsType");if(g)var p=g.getSelectedItem().mBindingInfos.key.binding.oContext.sPath;var t=this.getOwnerComponent().getModel("mainService");var c=t.getProperty(p);if(c.Tasklevel=="ASS001"){u.setValue("");u.setSelectedItem("");u.setSelectedKey("");u.setEditable(false);u.setVisible(false);this.byId("wbsTypeLabelModifica").setVisible(false);this.getView().byId("lModStartDate").setVisible(true);this.getView().byId("modStartDate").setVisible(true);this.getView().byId("lModEndDate").setVisible(true);this.getView().byId("modEndDate").setVisible(true);this.getView().byId("lModGiornoDate").setVisible(false);this.getView().byId("modGiornoDate").setVisible(false);this.getView().byId("lModOreLavorate").setVisible(false);this.getView().byId("modOreLavorate").setVisible(false)}else{u.setValue(d.Post1);u.setSelectedItem(d.Rproj);u.setSelectedKey(d.Rproj);u.setEditable(true);u.setVisible(true);this.byId("wbsTypeLabelModifica").setVisible(true);this.getView().byId("lModStartDate").setVisible(false);this.getView().byId("modStartDate").setVisible(false);this.getView().byId("lModEndDate").setVisible(false);this.getView().byId("modEndDate").setVisible(false);this.getView().byId("lModGiornoDate").setVisible(true);this.getView().byId("modGiornoDate").setVisible(true);this.getView().byId("lModOreLavorate").setVisible(true);this.getView().byId("modOreLavorate").setVisible(true);var h=this.getView().byId("planCaleTeam").getStartDate();var m=s.getDateInstance({style:"medium"}).format(h);this.getView().byId("modGiornoDate").setValue(m)}this.onChangeInputValuesModifica()},handleDialogModificaSaveButton:function(){var e=this.getOwnerComponent().getModel("jsonManagerService"),t=this.byId("modActType"),a="",r=this.byId("modWbsType"),s="",o=this.byId("modStartDate"),n=this.byId("modEndDate"),l=this.byId("modGiornoDate"),d=this.getOwnerComponent().getModel("mainService"),g=this.getOwnerComponent().getModel("keyModel"),u=this.byId("modificaDialogManager"),p;var c=g.getData().user,h=e.getProperty("/people"),m=e.getProperty("/people/"+h.findIndex(e=>e.key==c));if(n.getDateValue()===null){n.setDateValue(o.getDateValue())}if(o.getValueState()!==i.Error&&n.getValueState()!==i.Error){var y=this.getView().byId("modOreLavorate").getValue();if(!(y>0)){var b=o.getDateValue();var f=n.getDateValue()}else{b=l.getDateValue();f=l.getDateValue()}if(t.getSelectedItem()){a=t.getSelectedItem().mProperties.text}if(r.getSelectedItem()){s=r.getSelectedItem().mProperties.text}p={key:"",title:s,text:a,description:this.byId("modAppTitle").getValue(),longDescription:this.byId("modMoreInfo").getValue(),startDate:b,endDate:f,icon:"sap-icon://activity-2",selected:false,tentative:false,type:"",user:m.key,userPernr:m.key2,wbs:this.byId("modWbsType").getSelectedKey(),wbsDescription:s};this._addNewAppointmentModifica(p);d.updateBindings();u.close()}},_addNewAppointmentModifica:function(e){var t=this.getOwnerComponent().getModel("jsonManagerService"),a=this.byId("modStartDate").getDateValue(),r=this.byId("modEndDate").getDateValue(),i=this.byId("modGiornoDate").getDateValue(),l=this.getOwnerComponent().getModel("mainService"),d=this.getOwnerComponent().getModel("keyModel"),g=this,u;var p=s.getDateInstance({pattern:"PTHH'H'mm'M'ss'S'"});var c=this.getView().byId("modActType");var h=this.getView().byId("modWbsType");var m=this.getView().byId("modAppTitle");var y=this.getView().byId("modMoreInfo");var b,f;var u,I,D,S,T;if(c.getSelectedItem()){u=c.getSelectedItem().mBindingInfos.key.binding.oContext.sPath;I=l.getProperty(u);D={Tasktype:I.Tasktype,Tasklevel:I.Tasklevel,Tasklevelx:I.Tasklevelx}}else{D={Tasktype:"",Tasklevel:"",Tasklevelx:""}}if(h.getSelectedItem()){u=h.getSelectedItem().mBindingInfos.key.binding.oContext.sPath;S=l.getProperty(u);T={Rproj:S.Rproj,Posid:S.Posid,Post1:S.Post1}}else{T={Rproj:"",Posid:"",Post1:""}}if(!a)a=i;if(!r)r=i;var v=this.getView().byId("modOreLavorate").getValue();if(D.Tasklevel=="ASS001"){b=p.format(a);f=p.format(r)}else{var V=new Date;V.setHours("0");V.setMinutes("0");V.setSeconds("0");V.setMilliseconds("0");b=f=p.format(V)}var w=d.getData().key,x=d.getData().user,E=t.getProperty("/people"),M=t.getProperty("/people/"+E.findIndex(e=>e.key==x));var P={InputUname:M.key,InputPernr:M.key2,InputCounter:w,InputTsSearchFrom:a,InputTsSearchTo:r,Uname:M.key,Pernr:M.key2,Counter:w,Workdate:i,Rproj:T.Rproj,Posid:T.Posid,Post1:T.Post1,Tasktype:D.Tasktype,Tasklevel:D.Tasklevel,Tasklevelx:D.Tasklevelx,Catshours:v,Beguz:b,Enduz:f,Ltxa1:m.getValue(),LongText:y.getValue(),Status:"",Statusx:"",TsSearchFrom:a,TsSearchTo:r};var C=this.getOwnerComponent().getModel("mainService");sap.ui.core.BusyIndicator.show();C.callFunction("/ModificaUserEvent",{method:"GET",urlParameters:P,success:function(e){sap.ui.core.BusyIndicator.hide();if(e.message){var t=e.ModificaUserEvent.Message;n.error(t,{title:oI18n.getText("msgError"),styleClass:!jQuery.support.touch?"sapUiSizeCompact":""})}else{var a=g.getView().getModel("i18n").getResourceBundle();o.show(a.getText("msgOkEdited"));g._ricaricaUserEvent()}},error:function(e){sap.ui.core.BusyIndicator.hide();g.showUpdateError(e)}})},handleDialogModificaCancelButton:function(){this.byId("modificaDialogManager").close()},onPressBtnTeamAddAppointment:function(e){this._arrangeDialogFragmentCreate()},_arrangeDialogFragmentCreate:function(){sap.ui.core.BusyIndicator.show();var e=this.getView();if(!this._pNewAppointmentDialog){this._pNewAppointmentDialog=a.load({id:e.getId(),name:"zfioritimesheet3.zfioritimesheet3n.view.FragmentCreazioneManager",controller:this}).then(function(t,a){e.addDependent(t);return t})}this._pNewAppointmentDialog.then(function(e){this._arrangeDialogCreate(e)}.bind(this))},_arrangeDialogCreate:function(e){var t="",a=this.getOwnerComponent().getModel("i18n").getResourceBundle(),r=this.byId("selectDipName"),s=this.byId("actType"),o=this.byId("wbsType"),n=this.byId("createStartDate"),l=this.byId("createEndDate"),d=this.byId("createGiornoDate"),g=this.byId("oreLavorate"),u=this.byId("appTitle"),p=this.byId("moreInfo");r.setValueState(i.None);s.setValueState(i.None);o.setValueState(i.None);n.setValueState(i.None);l.setValueState(i.None);d.setValueState(i.None);g.setValueState(i.None);u.setValueState(i.None);p.setValueState(i.None);this._setCreateAppointmentDialogContentCreate();t=a.getText("titleCreateAppointmentDialog");e.setTitle(t);this.onChangeInputValuesCreate();sap.ui.core.BusyIndicator.hide();e.open()},_setCreateAppointmentDialogContentCreate:function(){var e=this.getOwnerComponent().getModel("jsonManagerService"),t=this.getView().byId("planCaleTeam"),a,r=this.byId("createStartDate"),i=this.byId("createEndDate"),o=this.byId("createGiornoDate"),n=this.byId("appTitle"),l=this.byId("moreInfo"),d=this.byId("selectDipName"),g=this.byId("actType"),u=this.byId("wbsType"),p=this.byId("wbsTypeLabelCreate"),c="LAV005",h="Lavoro",m,y,b,f,I,D,S=this.getOwnerComponent().getModel("paramModel"),T=e.getProperty("/people/0"),v;u.setEditable(true);u.setVisible(true);p.setVisible(true);if(t._dateNav._start){a=t._dateNav._start}else{a=new Date}if(S){if(S.oData){b=S.oData.startDate;f=S.oData.endDate;I=b.getHours().toString().padStart(2,"0")+":"+b.getMinutes().toString().padStart(2,"0");D=f.getHours().toString().padStart(2,"0")+":"+f.getMinutes().toString().padStart(2,"0");m=Math.abs(this.timeStringToDecimal(D)-this.timeStringToDecimal(I));if(m>0){y=this.roundTo2DecimalsString(m)}else{y=""}if(S.oData.row){d.setValue(S.oData.row.mProperties.text);d.setSelectedItem(S.oData.row.mProperties.key);d.setSelectedKey(S.oData.row.mProperties.key);v={userPernr:S.oData.row.mProperties.key2,user:S.oData.row.mProperties.key}}else if(S.oData.calendarRow){d.setValue(S.oData.calendarRow.mProperties.text);d.setSelectedItem(S.oData.calendarRow.mProperties.key);d.setSelectedKey(S.oData.calendarRow.mProperties.key);v={userPernr:S.oData.calendarRow.mProperties.key2,user:S.oData.calendarRow.mProperties.key}}else{d.setValue(T.text);d.setSelectedItem(T.key);d.setSelectedKey(T.key);v={userPernr:T.key2,user:T.key}}S.setData(null);S.updateBindings(true)}else{b=a;f=a;y="";d.setValue(T.text);d.setSelectedItem(T.key);d.setSelectedKey(T.key);v={userPernr:T.key2,user:T.key}}}else{b=a;f=a;y="";d.setValue(T.text);d.setSelectedItem(T.key);d.setSelectedKey(T.key);v={userPernr:T.key2,user:T.key}}var V=new Date(b),w=new Date(f);var x=new sap.ui.model.json.JSONModel;x.setData(v);this.getOwnerComponent().setModel(x,"keyModel");var E=s.getDateTimeInstance({style:"medium"}).format(V);var M=s.getDateTimeInstance({style:"medium"}).format(w);var P=s.getDateInstance({style:"medium"}).format(V);r.setValue(E);i.setValue(M);o.setValue(P);n.setValue("");l.setValue("");g.setValue(h);g.setSelectedItem(c);g.setSelectedKey(c);u.setSelectedKey("");u.setEditable(true);this.getView().byId("lCreateStartDate").setVisible(false);r.setVisible(false);this.getView().byId("lCreateEndDate").setVisible(false);i.setVisible(false);this.getView().byId("lGiornoDate").setVisible(true);o.setVisible(true);this.getView().byId("lOreLavorate").setVisible(true);this.getView().byId("oreLavorate").setVisible(true);this.getView().byId("oreLavorate").setValue(y)},handleDialogSaveButtonCreate:function(){sap.ui.core.BusyIndicator.show();var e=this.byId("createStartDate"),t=this.byId("createEndDate"),a=this.byId("moreInfo").getValue(),r=this.byId("appTitle").getValue(),s=this.getOwnerComponent().getModel("mainService"),o=this.byId("createDialogManager"),n;if(e.getValueState()!==i.Error&&t.getValueState()!==i.Error){n={title:r,info:a,start:e.getDateValue(),end:t.getDateValue()};this._addNewAppointmentCreate(n)}s.updateBindings();o.close()},_addNewAppointmentCreate:function(e){var t=this,a=t.getView(),r;var i=s.getDateInstance({pattern:"PTHH'H'mm'M'ss'S'"});var n=this.getOwnerComponent().getModel("keyModel");var l=this.getOwnerComponent().getModel("mainService");var d="";var g=null;var u=a.byId("appTitle");var p=a.byId("moreInfo");var c=a.byId("actType");var r,h,m;r=c.getSelectedItem().mBindingInfos.key.binding.oContext.sPath;h=l.getProperty(r);var y=a.byId("wbsType");if(y.getSelectedItem()){r=y.getSelectedItem().mBindingInfos.key.binding.oContext.sPath;m=l.getProperty(r)}else{m={Rproj:"",Posid:"",Post1:""}}var b=a.byId("createStartDate").getDateValue();var f=a.byId("createEndDate").getDateValue();var I=a.byId("createGiornoDate").getDateValue();var D=a.byId("oreLavorate").getValue();var S;if(a.byId("oreLavorate").getVisible())S="X";if(!S){D="0.00";var T=new Date(b);T.setHours(parseInt(b.getHours()),parseInt(b.getMinutes()),parseInt(b.getSeconds()));var v=i.format(T);T=new Date(f);T.setHours(parseInt(f.getHours()),parseInt(f.getMinutes()),parseInt(f.getSeconds()));var V=i.format(T)}else{v=g;V=g}if(f===g){f=b}var w=n.getData().user,x=n.getData().userPernr,E=this.dateToYyyyMmDd(I);var M={InputUname:d,InputPernr:d,InputCounter:d,InputTsSearchFrom:g,InputTsSearchTo:g,Uname:w,Pernr:x,Counter:"00000000000",Workdate:I,WorkdateChar:E,Rproj:m.Rproj,Posid:m.Posid,Post1:m.Post1,Tasktype:h.Tasktype,Tasklevel:h.Tasklevel,Tasklevelx:h.Tasklevelx,Catshours:D,Beguz:v,Enduz:V,Ltxa1:u.getValue(),LongText:p.getValue(),Status:d,Statusx:d,TsSearchFrom:g,TsSearchTo:g};var P=this.getOwnerComponent().getModel("mainService");P.create("/UserEventSet",M,{success:function(){sap.ui.core.BusyIndicator.hide();var e=a.getModel("i18n").getResourceBundle();o.show(e.getText("msgOkInsert"));t._ricaricaUserEvent()},error:function(e){sap.ui.core.BusyIndicator.hide();t.showCreateError(e)}})},onSelectDipNameChange:function(){var e=this.getOwnerComponent().getModel("jsonManagerService"),t=this.getOwnerComponent().getModel("keyModel"),a=this.byId("selectDipName").getSelectedKey(),r=e.getProperty("/people"),s=e.getProperty("/people/"+r.findIndex(e=>e.key==a));var i={userPernr:s.key2,user:s.key};t.setData(null);t.updateBindings(true);var o=new sap.ui.model.json.JSONModel;o.setData(i);this.getOwnerComponent().setModel(o,"keyModel");this.onChangeInputValuesCreate()},_ricaricaUserEvent:function(){var e=this,t="mainService",a="jsonManagerService",i=this.getOwnerComponent().getModel(t),o=this.getOwnerComponent().getModel(a),n=this.getOwnerComponent().getModel("keyModel");var l=n.getData().user,d=o.getProperty("/people"),g=o.getProperty("/people/"+d.findIndex(e=>e.key==l));var u=s.getDateInstance({pattern:"yyyy-MM-dd",UTC:false});var p=new Date,c=u.format(new Date(p.getFullYear(),p.getMonth()-1,p.getDate())),h=u.format(new Date(p.getFullYear(),p.getMonth()+1,p.getDate())),m=new r({filters:[new r({path:"InputUname",operator:sap.ui.model.FilterOperator.EQ,value1:g.key}),new r({path:"InputPernr",operator:sap.ui.model.FilterOperator.EQ,value1:g.key2}),new r({path:"InputTsSearchFrom",operator:sap.ui.model.FilterOperator.EQ,value1:c}),new r({path:"InputTsSearchTo",operator:sap.ui.model.FilterOperator.EQ,value1:h})],and:true}),y="";y=m;i.read("/UserEventSet",{filters:[y],success:function(t){var a=o.getProperty("/people"),r="/people/"+a.findIndex(e=>e.key==g.key)+"/appointments",s=o.getProperty(r),i,n;s.splice(0,s.length);for(n=0;n<t.results.length;n++){if(t.results[n].Uname===g.key){if(t.results[n].Tasktype=="AS01")t.results[n].Catshours="0.00";var l=new Date(t.results[n].Workdate),d,u,p;d=e.dateToYyyyMmDd(l)+"T"+e.msToTime(t.results[n].Beguz.ms);u=e.dateToYyyyMmDd(l)+"T"+e.msToTime(t.results[n].Enduz.ms);switch(t.results[n].Status){case"10":if(t.results[n].Tasklevel=="LAV005"){p="Type01"}else{p="Type08"}break;case"20":if(t.results[n].Tasklevel=="LAV005"){p="Type02"}else{p="Type09"}break;case"30":if(t.results[n].Tasklevel=="LAV005"){p="Type06"}else{p="Type10"}break;case"40":if(t.results[n].Tasklevel=="LAV005"){p="Type03"}else{p="Type11"}break;case"50":if(t.results[n].Tasklevel=="LAV005"){p="Type04"}else{p="Type12"}break;case"60":if(t.results[n].Tasklevel=="LAV005"){p="Type05"}else{p="Type13"}break;default:p="Type07"}i={key:t.results[n].Counter,title:t.results[n].Post1,text:t.results[n].Tasklevelx,description:t.results[n].Ltxa1,longDescription:t.results[n].LongText,startDate:d,endDate:u,icon:"sap-icon://activity-2",selected:false,tentative:false,type:p,user:t.results[n].Uname,userPernr:t.results[n].Pernr,wbs:t.results[n].Posid,wbsDescription:t.results[n].Post1};s.push(i)}}if(o.setProperty(r,s)){o.refresh();sap.ui.core.BusyIndicator.hide()}},error:function(t){sap.ui.core.BusyIndicator.hide();e.showUnknownError(t)}})},handleDialogCancelButtonCreate:function(){this.byId("createDialogManager").close()},handleChangeSelectActivityCreate:function(){var e;var t=this.getView().byId("actType");if(t)e=t.getSelectedItem().mBindingInfos.key.binding.oContext.sPath;var a=this.byId("wbsType");var r=this.getOwnerComponent().getModel("mainService");var s=r.getProperty(e);if(s.Tasklevel=="ASS001"){a.setValue("");a.setSelectedItem("");a.setSelectedKey("");a.setEditable(false);a.setVisible(false);this.byId("wbsTypeLabelCreate").setVisible(false);this.getView().byId("lCreateStartDate").setVisible(true);this.getView().byId("createStartDate").setVisible(true);this.getView().byId("lCreateEndDate").setVisible(true);this.getView().byId("createEndDate").setVisible(true);this.getView().byId("lGiornoDate").setVisible(false);this.getView().byId("createGiornoDate").setVisible(false);this.getView().byId("lOreLavorate").setVisible(false);this.getView().byId("oreLavorate").setVisible(false)}else{a.setEditable(true);a.setVisible(true);this.byId("wbsTypeLabelCreate").setVisible(true);this.getView().byId("lCreateStartDate").setVisible(false);this.getView().byId("createStartDate").setVisible(false);this.getView().byId("lCreateEndDate").setVisible(false);this.getView().byId("createEndDate").setVisible(false);this.getView().byId("lGiornoDate").setVisible(true);this.getView().byId("createGiornoDate").setVisible(true);this.getView().byId("lOreLavorate").setVisible(true);this.getView().byId("oreLavorate").setVisible(true)}this.onChangeInputValuesCreate()},validateStartEndDateTimePickerCreate:function(e,t){var a=this.getOwnerComponent().getModel("i18n").getResourceBundle(),r=e.getDateValue(),s=t.getDateValue();if(!e.getValue().replace(/\s+/g,"")){e.setValueState(i.Error);e.setValueStateText(a.getText("validationErrorTextEmptyStartDateTimePicker"))}else if(!e._bValid){e.setValueState(i.Error);e.setValueStateText(a.getText("validationErrorTextInvalidStartDateTimePicker"))}else{e.setValueState(i.None)}if(!t.getValue().replace(/\s+/g,"")){t.setValueState(i.Error);t.setValueStateText(a.getText("validationErrorTextEmptyEndDateTimePicker"))}else if(!t._bValid){t.setValueState(i.Error);t.setValueStateText(a.getText("validationErrorTextInvalidEndDateTimePicker"))}else{t.setValueState(i.None)}if(r&&s&&e.getValueState()!==i.Error&&t.getValueState()!==i.Error){if(s.getTime()<=r.getTime()){e.setValueState(i.Error);t.setValueState(i.Error);e.setValueStateText(a.getText("validationErrorTextStartEndDateTimePicker"));t.setValueStateText(a.getText("validationErrorTextStartEndDateTimePicker"))}else{e.setValueState(i.None);t.setValueState(i.None)}}},onChangeStartEndDateInputValuesCreate:function(){var e=this.byId("createStartDate"),t=this.byId("createEndDate"),a=this.byId("oreLavorate"),r=a.getVisible()?"X":"";if(!r){this.validateStartEndDateTimePickerCreate(e,t);this.updateButtonEnabledStateAfterInputValidationCreate(this.byId("createDialogManager"),r)}},onChangeInputValuesCreate:function(){var e=this.getOwnerComponent().getModel("i18n").getResourceBundle(),t=this.byId("selectDipName"),a=this.byId("actType"),r=this.byId("wbsType"),s=this.byId("createGiornoDate"),o=this.byId("oreLavorate"),n=this.byId("appTitle"),l=this.byId("moreInfo"),d=o.getVisible()?"X":"";if(!t.getSelectedKey()){t.setValueState(i.Error);t.setValueStateText(e.getText("validationErrorTextEmtpyUser"))}else{t.setValueState(i.None)}if(!a.getSelectedKey()){a.setValueState(i.Error);a.setValueStateText(e.getText("validationErrorTextEmtpyActivity"))}else{a.setValueState(i.None)}if(d){if(!r.getSelectedKey()){r.setValueState(i.Error);r.setValueStateText(e.getText("validationErrorTextEmtpyWbs"))}else{r.setValueState(i.None)}if(!o.getValue().toString().replace(/\s+/g,"")){o.setValueState(i.Error);o.setValueStateText(e.getText("validationErrorTextEmptyWorkedHours"))}else if(!(parseFloat(o.getValue())>0)){o.setValueState(i.Error);o.setValueStateText(e.getText("validationErrorTextInvalidWorkedHours"))}else if(parseFloat(o.getValue())>23.99){o.setValueState(i.Error);o.setValueStateText(e.getText("validationErrorTextLongerWorkedHours"))}else{o.setValueState(i.None)}if(!s.getValue().replace(/\s+/g,"")){s.setValueState(i.Error);s.setValueStateText(e.getText("validationErrorTextEmtpyWorkdate"))}else if(!s._bValid){s.setValueState(i.Error);s.setValueStateText(e.getText("validationErrorTextInvalidWorkdate"))}else{s.setValueState(i.None)}}if(n.getValue().length>40){n.setValueState(i.Error);n.setValueStateText(e.getText("validationErrorTextLongerShortDescription"))}else{n.setValueState(i.None)}if(l.getValue().length>132){l.setValueState(i.Error);l.setValueStateText(e.getText("validationErrorTextLongerAdditionalInformation"))}else{l.setValueState(i.None)}this.updateButtonEnabledStateAfterInputValidationCreate(this.byId("createDialogManager"),d)},updateButtonEnabledStateAfterInputValidationCreate:function(e,t){var a=this.byId("selectDipName"),r=this.byId("actType"),s=this.byId("wbsType"),o=this.byId("createStartDate"),n=this.byId("createEndDate"),l=this.byId("createGiornoDate"),d=this.byId("oreLavorate"),g=this.byId("appTitle"),u=this.byId("moreInfo"),p;if(t){p=a.getValueState()!==i.Error&&r.getValueState()!==i.Error&&s.getValueState()!==i.Error&&l.getValueState()!==i.Error&&d.getValueState()!==i.Error&&g.getValueState()!==i.Error&&u.getValueState()!==i.Error}else{p=a.getValueState()!==i.Error&&r.getValueState()!==i.Error&&o.getValueState()!==i.Error&&n.getValueState()!==i.Error&&g.getValueState()!==i.Error&&u.getValueState()!==i.Error}e.getBeginButton().setEnabled(p)},onChangeStartEndDateInputValuesModifica:function(){var e=this.byId("modStartDate"),t=this.byId("modEndDate"),a=this.byId("modOreLavorate"),r=a.getVisible()?"X":"";if(!r){this.validateStartEndDateTimePickerCreate(e,t);this.updateButtonEnabledStateAfterInputValidationModifica(this.byId("modificaDialogManager"),r)}},onChangeInputValuesModifica:function(){var e=this.getOwnerComponent().getModel("i18n").getResourceBundle(),t=this.byId("modActType"),a=this.byId("modWbsType"),r=this.byId("modOreLavorate"),s=this.byId("modAppTitle"),o=this.byId("modMoreInfo"),n=r.getVisible()?"X":"";if(!t.getSelectedKey()){t.setValueState(i.Error);t.setValueStateText(e.getText("validationErrorTextEmtpyActivity"))}else{t.setValueState(i.None)}if(n){if(!a.getSelectedKey()){a.setValueState(i.Error);a.setValueStateText(e.getText("validationErrorTextEmtpyWbs"))}else{a.setValueState(i.None)}if(!r.getValue().toString().replace(/\s+/g,"")){r.setValueState(i.Error);r.setValueStateText(e.getText("validationErrorTextEmptyWorkedHours"))}else if(!(parseFloat(r.getValue())>0)){r.setValueState(i.Error);r.setValueStateText(e.getText("validationErrorTextInvalidWorkedHours"))}else if(parseFloat(r.getValue())>23.99){r.setValueState(i.Error);r.setValueStateText(e.getText("validationErrorTextLongerWorkedHours"))}else{r.setValueState(i.None)}}if(s.getValue().length>40){s.setValueState(i.Error);s.setValueStateText(e.getText("validationErrorTextLongerShortDescription"))}else{s.setValueState(i.None)}if(o.getValue().length>132){o.setValueState(i.Error);o.setValueStateText(e.getText("validationErrorTextLongerAdditionalInformation"))}else{o.setValueState(i.None)}this.updateButtonEnabledStateAfterInputValidationModifica(this.byId("modificaDialogManager"),n)},updateButtonEnabledStateAfterInputValidationModifica:function(e,t){var a=this.byId("modActType"),r=this.byId("modWbsType"),s=this.byId("modStartDate"),o=this.byId("modEndDate"),n=this.byId("modOreLavorate"),l=this.byId("modAppTitle"),d=this.byId("modMoreInfo"),g;if(t){g=a.getValueState()!==i.Error&&r.getValueState()!==i.Error&&n.getValueState()!==i.Error&&l.getValueState()!==i.Error&&d.getValueState()!==i.Error}else{g=a.getValueState()!==i.Error&&s.getValueState()!==i.Error&&o.getValueState()!==i.Error&&l.getValueState()!==i.Error&&d.getValueState()!==i.Error}e.getBeginButton().setEnabled(g)},handleTeamAppointmentAddWithContext:function(e){var t=e.getParameters(),a=new sap.ui.model.json.JSONModel,r=new Date(t.endDate);t.endDate=new Date(r.getTime()+1e3);this.oClickEventParameters=t;a.setData(t);this.getOwnerComponent().setModel(a,"paramModel");this._arrangeDialogFragmentCreate()},onPlanCaleTeamCreate:function(e){var t=new sap.ui.model.json.JSONModel;t.setData(e.getParameters());this.getOwnerComponent().setModel(t,"paramModel");this.onPressBtnTeamAddAppointment(e)},onPlanCaleTeamDragEnter:function(e){var t=new sap.ui.model.json.JSONModel;var a={counter:e.mParameters.appointment.mProperties.key,user:e.oSource.mProperties.key};t.setData(a);this.getOwnerComponent().setModel(t,"keyModel");if(this.isAppointmentOverlap(e,e.getParameter("calendarRow"))){e.preventDefault()}},isAppointmentOverlap:function(e,t){var a=e.getParameter("appointment"),r=e.getParameter("startDate"),s=e.getParameter("endDate"),i;i=t.getAppointments().some(function(e){if(e===a){return}var t=e.getStartDate().getTime(),i=e.getEndDate().getTime();if(t<=r.getTime()&&r.getTime()<i){return true}if(t<s.getTime()&&s.getTime()<=i){return true}if(r.getTime()<=t&&t<s.getTime()){return true}});return i},onPlanCaleTeamResize:function(e){sap.ui.core.BusyIndicator.show();var t=e.getParameter("appointment"),a=new sap.ui.model.json.JSONModel,r={counter:e.mParameters.appointment.mProperties.key,user:e.oSource.mProperties.key};a.setData(r);this.getOwnerComponent().setModel(a,"keyModel");this._appointmentResize(t,e)},_appointmentResize:function(e,t){var a=t.getParameter("startDate"),r=t.getParameter("endDate"),i=this.getOwnerComponent().getModel("jsonManagerService"),l=this.getOwnerComponent().getModel("mainService"),d=this,g,u=s.getDateInstance({pattern:"PTHH'H'mm'M'ss'S'"});if(e.mBindingInfos===undefined){oAppointmentPath=t.getParameter("appointment");var g=oAppointmentPath.mBindingInfos.key.binding.oContext.sPath}else{g=e.mBindingInfos.key.binding.oContext.sPath}var p=i.getProperty(g);var c="UserEventSet(Uname='"+t.oSource.getKey()+"',Pernr='"+p.userPernr+"',Counter='"+t.getParameters().appointment.getProperty("key")+"')";var h=l.oData[c];if(h.Status!=="10"){sap.ui.core.BusyIndicator.hide();d.showErrorNotEditable();return false}var m=new Date(a);m.setHours(parseInt(a.getHours()),parseInt(a.getMinutes()),parseInt(a.getSeconds()));var y=u.format(m);m=new Date(r);m.setHours(parseInt(r.getHours()),parseInt(r.getMinutes()),parseInt(r.getSeconds()));var b=u.format(m);if(r===null){r.setDateValue(a)}var f=a;var I=a.getHours().toString().padStart(2,"0")+":"+a.getMinutes().toString().padStart(2,"0");var D=r.getHours().toString().padStart(2,"0")+":"+r.getMinutes().toString().padStart(2,"0");var S=Math.abs(this.timeStringToDecimal(D)-this.timeStringToDecimal(I));var T=this.roundTo2DecimalsString(S);var v={InputUname:h.InputUname,InputPernr:h.InputPernr,InputCounter:h.InputCounter,InputTsSearchFrom:a,InputTsSearchTo:r,Uname:h.Uname,Pernr:h.Pernr,Counter:h.Counter,Workdate:f,Rproj:h.Rproj,Posid:h.Posid,Post1:h.Post1,Tasktype:h.Tasktype,Tasklevel:h.Tasklevel,Tasklevelx:h.Tasklevelx,Catshours:T,Beguz:y,Enduz:b,Ltxa1:h.Ltxa1,LongText:h.LongText,Status:h.Status,Statusx:h.Statusx,TsSearchFrom:a,TsSearchTo:r};l.callFunction("/ModificaUserEvent",{method:"GET",urlParameters:v,success:function(e){sap.ui.core.BusyIndicator.hide();if(e.message){var t=e.ModificaUserEvent.Message;n.error(t,{title:oI18n.getText("msgError"),styleClass:!jQuery.support.touch?"sapUiSizeCompact":""})}else{var a=d.getView().getModel("i18n").getResourceBundle();o.show(a.getText("msgOkEdited"));d._ricaricaUserEvent()}},error:function(e){sap.ui.core.BusyIndicator.hide();d.showUpdateError(e)}})}})});